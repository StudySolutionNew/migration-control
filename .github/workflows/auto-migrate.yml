name: Auto GitLab Sync

on:
  push:
    paths:
      - ".github/migration-requests/*.yml"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      gitlab_url: ${{ steps.vars.outputs.gitlab_url }}
      target_repo: ${{ steps.vars.outputs.target_repo }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find changed migration request file
        id: file
        shell: bash
        run: |
          set -euo pipefail
          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          if [[ "$before" == "0000000000000000000000000000000000000000" ]]; then
            # 첫 push인 경우: 그냥 하나 고르기(여러 개면 최신 1개)
            file=$(git ls-files ".github/migration-requests/*.yml" | tail -n 1 || true)
          else
            file=$(git diff --name-only "$before" "$after" -- ".github/migration-requests/*.yml" | head -n 1 || true)
          fi

          if [[ -z "$file" ]]; then
            echo "No migration request file changed."
            exit 1
          fi

          echo "file=$file" >> "$GITHUB_OUTPUT"
          echo "Changed file: $file"

      - name: Extract variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          file="${{ steps.file.outputs.file }}"

          gitlab_url=$(grep '^gitlab_url:' "$file" | awk '{print $2}' | tr -d '"')
          target_repo=$(grep '^target_repo:' "$file" | awk '{print $2}' | tr -d '"')

          if [[ -z "$gitlab_url" || -z "$target_repo" ]]; then
            echo "gitlab_url or target_repo is empty. file=$file"
            exit 1
          fi

          echo "gitlab_url=$gitlab_url" >> "$GITHUB_OUTPUT"
          echo "target_repo=$target_repo" >> "$GITHUB_OUTPUT"

  migrate:
    needs: prepare
    uses: ./.github/workflows/migrate-project.yml
    with:
      gitlab_url: ${{ needs.prepare.outputs.gitlab_url }}
      target_repo: ${{ needs.prepare.outputs.target_repo }}
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}
