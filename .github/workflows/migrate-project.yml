name: GitLab to GitHub Migration

on:
  workflow_dispatch:
    inputs:
      gitlab_url:
        description: "GitLab repository URL"
        required: true
      target_repo:
        description: "GitHub target repository name"
        required: true

  workflow_call:
    inputs:
      gitlab_url:
        required: true
        type: string
      target_repo:
        required: true
        type: string
    secrets:
      GH_PAT:
        required: true

jobs:
  migrate:
    runs-on: [self-hosted, migration]

    steps:
      - name: Install git & GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y git gh
          git --version
          gh --version

      - name: Clean previous workspace
        run: |
          if [ -d "source-repo" ]; then
            rm -rf source-repo
          fi

      - name: Clone from GitLab (mirror)
        run: |
          git clone --mirror "${{ inputs.gitlab_url || github.event.inputs.gitlab_url }}" source-repo

      - name: Create GitHub repo if not exists
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -e
          repo="StudySolutionNew/${{ inputs.target_repo || github.event.inputs.target_repo }}"
          if gh repo view "$repo" >/dev/null 2>&1; then
            echo "Repo already exists. Skipping create."
          else
            echo "Repo not found. Creating..."
            gh repo create "$repo" --public --confirm
          fi

      - name: Push to GitHub (mirror)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          cd source-repo
          git remote remove origin || true
          repo="${{ inputs.target_repo || github.event.inputs.target_repo }}"
          git remote add origin "https://x-access-token:${GH_PAT}@github.com/StudySolutionNew/${repo}.git"
          git push --mirror
